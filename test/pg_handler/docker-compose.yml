version: '3.0'

services:
  pg:
    build:
      context: .
      dockerfile: Dockerfile.pg
    ports:
      - 5432
    command: -c ssl=on -c ssl_cert_file=/var/lib/postgresql/server.crt -c ssl_key_file=/var/lib/postgresql/server.key
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 1s
      timeout: 30s
    volumes:
      - psql-data_tls:/var/lib/postgresql/data

  pg_no_tls:
    build:
      context: .
      dockerfile: Dockerfile.pg
    ports:
      - 5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 1s
      timeout: 30s
    volumes:
      - psql-data_no_tls:/var/lib/postgresql/data

  secretless:
    build:
      context: ../..
    environment:
      PG_TLS_ADDRESS:
      PG_NO_TLS_ADDRESS:
      PG_PASSWORD: test
    ports:
      - 15432
      - 25432
    volumes:
      - ./secretless.yml:/secretless.yml
      - pg-socket:/sock

  test:
    build:
      context: .
      dockerfile: Dockerfile.dev
    volumes:
      - pg-socket:/sock
    depends_on:
      - secretless

  dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    environment:
      PG_PASSWORD: test
      PG_ADDRESS: pg:5432
      SECRETLESS_ADDRESS: secretless:15432
    volumes:
      - ../..:/secretless
      - pg-socket:/sock

volumes:
  pg-socket:
  psql-data_tls:
  psql-data_no_tls:
