#!/bin/bash -e

. bin/build_utils

readonly TAG="${1:-$(version_tag)}"
readonly VERSION="$(cat VERSION)"
readonly REGISTRY="${1:-cyberark}"

readonly IMAGES=(
  "secretless-broker"
  "secretless-broker-quickstart"
)

readonly TAGS=(
  "$VERSION"
  "latest"
)

for image_name in "${IMAGES[@]}"; do
  # always push the tag with the commit hash
  echo "Pushing $REGISTRY/$image_name:${TAG}"
  docker push "$REGISTRY/$image_name:$TAG"

  # if the tag matches the VERSION, push VERSION and latest releases
  # and x and x.y releases
  if [ "$(git_description)" = "v${VERSION}" ]; then
    echo "Revision $(git_description) matches version $VERSION exactly. Pushing to Dockerhub..."

    for tag in "${TAGS[@]}" $(gen_versions $VERSION); do
      echo "Tagging and pushing $REGISTRY/$image_name:$tag"
      tag_and_push $tag $REGISTRY/$image_name
    done
  fi
done
