image: codebykumbi/docker-compose-bash:stable-git

stages:
  - build
  - test
  - website

build:
  stage: build
  services:
  - docker:stable-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - setup_docker
    - ./bin/build
    - save_images
  only:
    - branches

check_style:
  stage: test
  services:
  - docker:stable-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - setup_docker
    - get_images
    - ./bin/check_style
  only:
    - branches
  artifacts:
    paths:
      - test/golint.xml

test_unit:
  stage: test
  services:
  - docker:stable-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - setup_docker
    - get_images
    - ./bin/test_unit
  only:
    - branches
  artifacts:
    reports:
      junit: test/junit.xml

test_integration:
  stage: test
  services:
  - docker:stable-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - setup_docker
    - get_images
    - ./bin/test_integration
  only:
    - branches
  artifacts:
    reports:
      junit: test/junit.xml

test_demo:
  stage: test
  services:
  - docker:stable-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - setup_docker
    - get_images
    - ./bin/test_demo
  only:
    - branches

website:
  stage: website
  services:
  - docker:stable-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - setup_docker
    - get_images
    - ./bin/build_website
    - ./bin/check_website_links
  only:
    - branches

before_script:
  - . ./bin/build_utils_gitlab
