#!/bin/bash
#
# Builds secretless binaries
# usage: ./bin/build
set -ex

VERSION=$(cat VERSION)
QUICK_START_REL_DIR="$(dirname $0)/../demos/quick-start/docker"
QUICK_START_DIR="$(realpath "$QUICK_START_REL_DIR")"

DOCKER_FLAGS=""
if [ "${KEEP_ALIVE}" != "" ]; then
  DOCKER_FLAGS="${DOCKER_FLAGS} -rm=false"
else
  DOCKER_FLAGS="${DOCKER_FLAGS} --force-rm"
fi

echo "Building Docker image"
docker build -t "secretless-broker:${VERSION}" \
             -t "secretless-broker:latest" \
             $DOCKER_FLAGS \
             .

echo "Building Docker dev image"
docker build -t "secretless-dev:${VERSION}" \
             -t "secretless-dev:latest" \
             $DOCKER_FLAGS \
             -f Dockerfile.dev \
             .

echo "Building Docker Quick-Start image"
docker build -t "secretless-broker-quickstart:${VERSION}" \
             -t "secretless-broker-quickstart:latest" \
             $DOCKER_FLAGS \
             -f "$QUICK_START_DIR/Dockerfile" \
             "$QUICK_START_DIR"
