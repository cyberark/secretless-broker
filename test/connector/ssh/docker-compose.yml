version: '3.0'

services:
  ssh-host:
    build:
      context: .
      dockerfile: Dockerfile.ssh_host
    ports:
      - 22
    volumes:
      - ./http-basic-auth.conf:/etc/nginx/conf.d/default.conf:ro
      - ./basic_auth.htpasswd:/etc/nginx/.htpasswd:ro

  secretless:
    image: secretless-broker # Local image built from REPO_ROOT/bin/build
    hostname: secretless
    ports:
      - 2222
    volumes:
      - ./secretless.yml:/secretless.yml
      - ./id_insecure:/id_insecure:ro
    depends_on:
      - ssh-host

  test:
    build:
      context: .
      dockerfile: Dockerfile.ssh_host
    command: ssh -o StrictHostKeyChecking=no -o HostKeyAlgorithms=ssh-rsa -o UserKnownHostsFile=/dev/null -p 2222 secretless ls -la
    depends_on:
      - secretless
    volumes:
      - ./id_insecure:/root/id_insecure:ro

  secretless-dev:
    image: secretless-dev
    command: ./bin/reflex
    hostname: secretless
    ports:
      - 2222
    volumes:
      - ./secretless.yml:/secretless.yml
      - ./id_insecure:/id_insecure:ro
      - ../../..:/secretless
    depends_on:
      - ssh-host
