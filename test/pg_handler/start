#!/bin/bash -ex

SECRETLESS_HOST=secretless
while getopts :d opt; do
    case $opt in
        d) SECRETLESS_HOST=secretless-dev;;
       \?) echo "Unknown option -$OPTARG"; exit 1;;
    esac
done

./stop

docker-compose build

docker-compose up \
  -d \
  pg pg_no_tls

./wait-for-pg pg_no_tls
./wait-for-pg pg

# generate fixtures
#
# NOTE: the tests depend on
# + secretless.yml auto-generation (also depended on by the secretless container)
# + fixture generation
# so there needs to be coordination of this bash script and the go files
#
## valid-ca.pem
## NOTE this should come before secretless.yml because it is required by the autogen
# TODO: have actual valid CA
cp ./etc/rootCA.crt ./fixtures/valid-ca.pem
## secretless.yml
docker-compose run --rm test \
  bash -c "
  go run ./test/util/test/cmd/generate_secretless_yml.go
"

# start secretless once pg is running
docker-compose up \
  -d \
  ${SECRETLESS_HOST}

./wait-for-secretless ${SECRETLESS_HOST}
