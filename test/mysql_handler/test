#!/bin/bash -ex

local_test=false
while getopts ":lb" opt; do
    case $opt in
        l) local_test=true ;;
        b) benchmark=true ;;
       \?) echo "Unknown option -$OPTARG"; exit 1;;
    esac
done

docker_args=""
if $local_test; then
  docker_args="-v $(cd ../..; pwd):/secretless"
fi

docker-compose build test

if $benchmark; then
  # first set MYSQL_ADDRESS and SECRETLESS_ADDRESS
  mysql_cid=$(docker-compose ps -q mysql)
  secretless_cid=$(docker-compose ps -q secretless)
  mysql_ip=$(docker inspect \
    -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $mysql_cid)
  secretless_ip=$(docker inspect \
    -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $secretless_cid)

  export MYSQL_ADDRESS=$mysql_ip:3306
  export SECRETLESS_ADDRESS=$secretless_ip:13306

  echo "++++++++++++++++++++++++++++++++++++++"
  echo ""
  echo "Running MySQL benchmarks ..."
  echo ""
  echo "++++++++++++++++++++++++++++++++++++++"

docker-compose run \
  --rm \
  --no-deps \
  $docker_args \
  test \
  bash -c '
    echo "--- QUERYING MYSQL DIRECTLY ---";
    BENCH_ADDRESS=$MYSQL_ADDRESS \
      go test -v -bench=. -test.benchtime=10s \
     ./test/mysql_handler/bench_test.go \
     | tee bench.old;

    echo "--- QUERYING VIA SECRETLESS ---";
    BENCH_ADDRESS=$SECRETLESS_ADDRESS \
      go test -v -bench=. -test.benchtime=10s \
      ./test/mysql_handler/bench_test.go \
      | tee bench.new;

    echo "--- COMPARING BENCHMARKS ---";
    benchcmp bench.old bench.new
  '

else
  docker-compose run \
    --rm \
    --no-deps \
    $docker_args \
    test \
    go test -v ./test/mysql_handler
fi
